<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petualangan Angka Ajaib</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .screen { display: none; }
        .screen.active { display: flex; }
        .keypad-btn { transition: all 0.1s ease; }
        .keypad-btn:active { transform: scale(0.95); }
        .star-container { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .kiko-character { width: 100px; height: auto; }
        .speech-bubble {
            position: relative; background: #ffffff; border-radius: .4em;
            padding: 0.75rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .speech-bubble:after {
            content: ''; position: absolute; bottom: 0; left: 20%;
            width: 0; height: 0; border: 15px solid transparent;
            border-top-color: #ffffff; border-bottom: 0; border-left: 0;
            margin-left: -7.5px; margin-bottom: -15px;
        }
        #confirmModal, #levelInfoModal { display: none; }
        #confirmModal.active, #levelInfoModal.active { display: flex; }

        .digit.active-column {
            color: #2563eb;
            font-weight: bold;
            transform: scale(1.1);
        }
        .strikethrough { position: relative; display: inline-block; }
        .strikethrough::after {
            content: ''; position: absolute; top: 50%; left: 0;
            right: 0; border-top: 4px solid #ef4444;
            transform: rotate(-10deg);
        }
    </style>
</head>
<body class="bg-gradient-to-b from-cyan-400 to-blue-600 min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="welcomeScreen" class="screen active flex-col items-center justify-center text-center text-white">
        <h1 class="text-5xl md:text-7xl font-bold text-yellow-300 drop-shadow-lg mb-4">Petualangan Angka Ajaib</h1>
        <svg class="kiko-character my-6 h-auto w-32" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <path fill="#F2A25C" d="M49.8,-53.4C63.2,-42.9,71.8,-26.6,74.5,-9.5C77.2,7.6,73.9,25.4,63.9,39.3C53.8,53.2,36.9,63.1,19.9,68.9C2.9,74.7,-14.3,76.4,-30.7,70.5C-47.1,64.7,-62.7,51.4,-70.2,35.4C-77.7,19.4,-77.1,0.8,-70.7,-14.8C-64.4,-30.4,-52.3,-43,-38.7,-51.2C-25,-59.4,-9.9,-63.3,4.9,-64.3C19.7,-65.3,36.5,-63.9,49.8,-53.4Z" transform="translate(100 100)" />
            <circle cx="90" cy="80" r="8" fill="black"/><circle cx="130" cy="80" r="8" fill="black"/><path d="M 100 95 Q 110 110 120 95" stroke="black" stroke-width="4" fill="none" />
        </svg>
        <p class="text-xl mb-8">Ayo belajar berhitung bersama Kiko!</p>
        <button id="startButton" class="bg-yellow-400 hover:bg-yellow-500 text-blue-800 font-bold text-2xl py-4 px-10 rounded-full shadow-lg transform hover:scale-105 transition-transform">Mulai!</button>
    </div>

    <div id="modeSelectScreen" class="screen flex-col items-center justify-center text-center text-white">
        <h2 class="text-4xl font-bold mb-8 drop-shadow-md">Pilih Operasi Hitung</h2>
        <div class="w-full max-w-md mt-8">
            <div class="grid grid-cols-2 gap-4">
                 <button class="mode-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-8 px-6 rounded-lg shadow-lg text-6xl" data-mode="addition">+</button>
                 <button class="mode-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-8 px-6 rounded-lg shadow-lg text-6xl" data-mode="subtraction">-</button>
            </div>
        </div>
        <button id="backToHomeBtn" class="mt-8 text-yellow-300 hover:text-white transition">Kembali ke Menu Awal</button>
    </div>

    <div id="levelSelectScreen" class="screen flex-col items-center justify-center text-center text-white">
        <h2 class="text-4xl font-bold mb-8 drop-shadow-md">Pilih Level</h2>
        <div class="w-full max-w-2xl grid grid-cols-2 md:grid-cols-3 gap-4">
            <button class="level-btn bg-green-500 hover:bg-green-600 text-white font-bold p-4 rounded-lg shadow-lg text-xl" data-level="1">Level 1<br><span class="text-base font-normal">(2 Digit Tanpa Simpan)</span></button>
            <button class="level-btn bg-blue-500 hover:bg-blue-600 text-white font-bold p-4 rounded-lg shadow-lg text-xl" data-level="2">Level 2<br><span class="text-base font-normal">(2 Digit Dg. Simpan)</span></button>
            <button class="level-btn bg-orange-500 hover:bg-orange-600 text-white font-bold p-4 rounded-lg shadow-lg text-xl" data-level="3">Level 3<br><span class="text-base font-normal">(3 Digit)</span></button>
            <button class="level-btn bg-red-500 hover:bg-red-600 text-white font-bold p-4 rounded-lg shadow-lg text-xl" data-level="4">Level 4<br><span class="text-base font-normal">(4 Digit)</span></button>
            <button class="level-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold p-4 rounded-lg shadow-lg text-xl col-span-2 md:col-span-1" data-level="5">Level 5<br><span class="text-base font-normal">(5 Digit)</span></button>
        </div>
        <button id="backToModeBtn" class="mt-8 text-yellow-300 hover:text-white transition">Kembali Pilih Mode</button>
    </div>
    
    <div id="gameScreen" class="screen flex-col w-full h-full max-w-md mx-auto justify-between py-4">
        <div>
            <div class="w-full flex justify-between items-center text-white mb-4 px-2">
                <div class="font-bold text-xl">Level: <span id="levelDisplay"></span></div>
                <div class="font-bold text-xl">Skor: <span id="scoreDisplay">0</span></div>
            </div>
            <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-2xl w-full">
                <div class="flex justify-end">
                     <div id="problem-grid" class="inline-grid items-center gap-x-2 sm:gap-x-3 text-6xl font-bold tracking-wider">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="w-full">
            <div id="feedback" class="text-4xl text-white text-center font-bold h-12 mb-2"></div>
             <div class="flex items-end mt-2 w-full max-w-xs mx-auto">
                 <div class="flex-shrink-0">
                    <svg class="kiko-character -scale-x-100" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><path fill="#F2A25C" d="M49.8,-53.4C63.2,-42.9,71.8,-26.6,74.5,-9.5C77.2,7.6,73.9,25.4,63.9,39.3C53.8,53.2,36.9,63.1,19.9,68.9C2.9,74.7,-14.3,76.4,-30.7,70.5C-47.1,64.7,-62.7,51.4,-70.2,35.4C-77.7,19.4,-77.1,0.8,-70.7,-14.8C-64.4,-30.4,-52.3,-43,-38.7,-51.2C-25,-59.4,-9.9,-63.3,4.9,-64.3C19.7,-65.3,36.5,-63.9,49.8,-53.4Z" transform="translate(100 100)" /></svg>
                </div>
                <div id="kikoMessage" class="speech-bubble flex-1 text-gray-800 text-center text-sm sm:text-base">Kerjakan dari kanan ya!</div>
            </div>
        </div>

        <div class="w-full flex flex-col items-center">
            <div id="keypad" class="grid grid-cols-6 gap-2 w-full max-w-xs bg-white/30 p-3 rounded-xl">
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="1">1</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="2">2</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="3">3</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="4">4</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="5">5</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="6">6</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="7">7</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="8">8</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md text-gray-800" data-key="9">9</button>
                <button class="keypad-btn bg-white/80 hover:bg-white text-3xl font-bold p-3 rounded-lg shadow-md col-span-2" data-key="0">0</button>
                <button class="keypad-btn bg-yellow-400 hover:bg-yellow-500 text-xl font-bold p-3 rounded-lg shadow-md" data-key="del">Hapus</button>
            </div>
            <button id="backToMenuFromGameBtn" class="mt-4 bg-red-500/80 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-full shadow-lg text-sm">Keluar</button>
        </div>
    </div>
    
    <div id="resultScreen" class="screen flex-col items-center justify-center text-center text-white">
        <h2 class="text-5xl font-bold mb-4 drop-shadow-md">Kerja Bagus!</h2>
        <div id="starContainer" class="flex my-6 star-container"></div>
        <p class="text-2xl mb-2">Skor Akhirmu:</p>
        <p id="finalScore" class="text-7xl font-bold mb-8"></p>
        <div class="flex gap-4">
            <button id="playAgainBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold text-xl py-3 px-8 rounded-full shadow-lg">Pilih Level Lain</button>
            <button id="mainMenuBtn" class="bg-yellow-400 hover:bg-yellow-500 text-blue-800 font-bold text-xl py-3 px-8 rounded-full shadow-lg">Menu Utama</button>
        </div>
    </div>
    
    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 text-center shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Kembali ke Menu?</h3>
            <p class="text-gray-600 mb-6">Progres permainan akan hilang. Kamu yakin?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmYesBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Ya, Kembali</button>
                <button id="confirmNoBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Batal</button>
            </div>
        </div>
    </div>
    
    <div id="levelInfoModal" class="fixed inset-0 bg-black/50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 text-center shadow-xl max-w-sm w-full">
            <h3 id="infoModalTitle" class="text-2xl font-bold text-orange-500 mb-4"></h3>
            <p id="infoModalText" class="text-gray-600 mb-6"></p>
            <button id="startLevelBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-8 rounded-lg">Mengerti!</button>
        </div>
    </div>

<script>
    const screens = document.querySelectorAll('.screen');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const modeSelectScreen = document.getElementById('modeSelectScreen');
    const levelSelectScreen = document.getElementById('levelSelectScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');
    
    const startButton = document.getElementById('startButton');
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const backToModeBtn = document.getElementById('backToModeBtn');
    
    const levelDisplay = document.getElementById('levelDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const problemGrid = document.getElementById('problem-grid');
    const keypad = document.getElementById('keypad');
    const feedbackEl = document.getElementById('feedback');
    const kikoMessage = document.getElementById('kikoMessage');
    
    const finalScoreEl = document.getElementById('finalScore');
    const starContainer = document.getElementById('starContainer');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const mainMenuBtn = document.getElementById('mainMenuBtn');
    const backToMenuFromGameBtn = document.getElementById('backToMenuFromGameBtn');
    
    const confirmModal = document.getElementById('confirmModal');
    const confirmYesBtn = document.getElementById('confirmYesBtn');
    const confirmNoBtn = document.getElementById('confirmNoBtn');
    
    const levelInfoModal = document.getElementById('levelInfoModal');
    const infoModalTitle = document.getElementById('infoModalTitle');
    const infoModalText = document.getElementById('infoModalText');
    const startLevelBtn = document.getElementById('startLevelBtn');

    let currentInput;

    let currentLevel = 1;
    let currentMode = 'addition';
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    const TOTAL_QUESTIONS = 5;

    let qNum1Arr = [];
    let qNum2Arr = [];
    let currentColumn = 0;
    let carry = 0;
    let finalAnswer = '';

    const showScreen = (screenId) => {
        screens.forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    };
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    function generateQuestions() {
        questions = [];
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            let num1, num2;
            const digits = currentLevel >= 3 ? currentLevel : 2;
            const min = 10 ** (digits - 1);
            const max = (10 ** digits) - 1;

            if (currentLevel === 1) {
                if (currentMode === 'addition') {
                    do {
                        num1 = randInt(10, 88);
                        num2 = randInt(10, 88);
                    } while (String(num1 + num2).length > 2 || (num1 % 10) + (num2 % 10) >= 10);
                } else {
                    do {
                        num1 = randInt(20, 99);
                        num2 = randInt(10, num1 - 1);
                    } while ((num1 % 10) < (num2 % 10));
                }
            } else if (currentLevel === 2) {
                 if (currentMode === 'addition') {
                    do { num1 = randInt(11, 88); num2 = randInt(11, 88); } while ((num1 % 10) + (num2 % 10) < 10);
                } else {
                    do { num1 = randInt(21, 98); num2 = randInt(11, num1 - 1); } while ((num1 % 10) >= (num2 % 10));
                }
            } else {
                num1 = randInt(min, max);
                num2 = randInt(min, max);
                if (currentMode === 'subtraction' && num1 < num2) {
                    [num1, num2] = [num2, num1];
                }
            }
            questions.push({ num1, num2, answer: currentMode === 'addition' ? num1 + num2 : num1 - num2 });
        }
    }
    
    function startGame() {
        currentQuestionIndex = 0;
        score = 0;
        scoreDisplay.textContent = score;
        feedbackEl.textContent = '';
        generateQuestions();
        
        if (currentLevel === 1) {
            infoModalTitle.textContent = "Level 1: Jawaban Langsung";
            infoModalText.innerHTML = "Ketik jawaban akhir dari soal, lalu tekan tombol <b>Cek</b>. Tidak ada proses menyimpan di level ini.";
        } else {
            infoModalTitle.textContent = `Level ${currentLevel}: Langkah per Langkah`;
            infoModalText.innerHTML = "Hitung satu kolom dari kanan, lalu ketik <b>hasilnya</b> (misal: '13') dan tekan tombol <b>Cek</b> untuk lanjut.";
        }
        levelInfoModal.classList.add('active');
    }

    startLevelBtn.addEventListener('click', () => {
        levelInfoModal.classList.remove('active');
        displayQuestion();
        showScreen('gameScreen');
    });

    function displayQuestion() {
        if (currentQuestionIndex >= questions.length) {
            showResult();
            return;
        }
        const q = questions[currentQuestionIndex];
        levelDisplay.textContent = currentLevel;
        problemGrid.innerHTML = '';
        
        currentColumn = 0;
        carry = 0;
        finalAnswer = '';
        
        qNum1Arr = String(q.num1).split('').map(Number);
        const numDigits = qNum1Arr.length;
        qNum2Arr = String(q.num2).padStart(numDigits, '0').split('').map(Number);
        
        const fontSizeClass = numDigits > 3 ? (numDigits > 4 ? 'text-4xl' : 'text-5xl') : 'text-6xl';
        problemGrid.className = `inline-grid items-center gap-x-2 sm:gap-x-3 ${fontSizeClass} font-bold tracking-wider`;
        
        problemGrid.style.gridTemplateColumns = `repeat(${numDigits}, auto) auto`;
        const totalCols = numDigits + 1;

        for(let i = 0; i < numDigits; i++) {
            const cell = document.createElement('div');
            cell.id = `carry-digit-${i}`;
            cell.className = 'text-right text-orange-500 text-4xl h-10';
            cell.innerHTML = '&nbsp;';
            problemGrid.appendChild(cell);
        }
        problemGrid.appendChild(document.createElement('div'));

        qNum1Arr.forEach((d, i) => {
            const cell = document.createElement('div');
            cell.id = `d1-${i}`;
            cell.className = 'digit text-right text-gray-800';
            cell.textContent = d;
            problemGrid.appendChild(cell);
        });
        problemGrid.appendChild(document.createElement('div'));

        qNum2Arr.forEach((d, i) => {
            const cell = document.createElement('div');
            cell.id = `d2-${i}`;
            cell.className = 'digit text-right text-gray-800';
            cell.textContent = d;
            problemGrid.appendChild(cell);
        });
        const opCell = document.createElement('div');
        opCell.className = `ml-3 ${fontSizeClass === 'text-6xl' ? 'text-5xl' : 'text-4xl'} text-gray-800`;
        opCell.textContent = currentMode === 'addition' ? '+' : '-';
        problemGrid.appendChild(opCell);
        
        const hr = document.createElement('hr');
        hr.className = `col-span-${totalCols} border-t-4 border-gray-700 my-2`;
        problemGrid.appendChild(hr);
        
        const answerCell = document.createElement('div');
        answerCell.className = `col-span-${numDigits} text-blue-600 flex justify-end items-center text-right`;
        answerCell.innerHTML = `
            <span id="finalAnswerDisplay"></span>
            <div id="currentInputWrapper" class="inline-flex items-center">
                <span id="currentInput" class="text-gray-400"></span>
                <span class="animate-ping">|</span>
            </div>
        `;
        problemGrid.appendChild(answerCell);
        
        const btnCell = document.createElement('div');
        btnCell.innerHTML = `<button id="submitStepBtn" class="keypad-btn bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-3 px-5 rounded-lg shadow-md self-center">Cek</button>`;
        problemGrid.appendChild(btnCell);
        
        currentInput = document.getElementById('currentInput');
        finalAnswerDisplay = document.getElementById('finalAnswerDisplay');
        
        document.getElementById('submitStepBtn').addEventListener('click', () => {
            if (currentLevel === 1) {
                processLevel1();
            } else {
                processLevel2();
            }
        });

        if (currentLevel > 1) {
            highlightCurrentColumn();
        }
        updateKikoMessage('default');
    }

    function highlightCurrentColumn() {
        document.querySelectorAll('.digit').forEach(d => d.classList.remove('active-column'));
        const digitIndex = qNum1Arr.length - 1 - currentColumn;
        document.getElementById(`d1-${digitIndex}`)?.classList.add('active-column');
        document.getElementById(`d2-${digitIndex}`)?.classList.add('active-column');
    }
    
    function processLevel1() {
        const userAnswer = parseInt(currentInput.textContent);
        const correctAnswer = questions[currentQuestionIndex].answer;
        if (userAnswer === correctAnswer) {
            handleCorrectAnswer();
        } else {
            handleIncorrectAnswer();
        }
    }

    function processLevel2() {
        const userInput = parseInt(currentInput.textContent);
        if (isNaN(userInput)) return;

        const colIndex1 = qNum1Arr.length - 1 - currentColumn;
        let d1 = qNum1Arr[colIndex1] ?? 0;
        let d2 = qNum2Arr[colIndex1] ?? 0;

        if (currentMode === 'addition') {
            const correctSum = d1 + d2 + carry;
            if (userInput === correctSum) {
                const digitForAnswer = correctSum % 10;
                finalAnswer = digitForAnswer + finalAnswer;
                finalAnswerDisplay.textContent = finalAnswer;
                currentInput.textContent = '';
                
                carry = Math.floor(correctSum / 10);
                
                if (carry > 0) {
                   const carryTargetIndex = colIndex1 - 1;
                   if (carryTargetIndex >= 0) {
                       const carryEl = document.getElementById(`carry-digit-${carryTargetIndex}`);
                       if(carryEl) {
                           carryEl.textContent = carry;
                           carryEl.className = 'inline-block text-4xl opacity-0 transform -translate-y-4 text-right text-orange-500';
                           setTimeout(() => carryEl.className = 'inline-block text-4xl opacity-100 transform translate-y-0 transition-all duration-300 text-right text-orange-500', 50);
                       }
                   }
                }
                moveToNextStep();
            } else {
                handleIncorrectAnswer(true);
            }
        } else { // Subtraction
            let tempD1 = d1 + carry;
            carry = 0;

            if (tempD1 < d2) {
                updateKikoMessage('borrow_hint');
                let borrowFromIndex = colIndex1 - 1;
                if(borrowFromIndex >= 0){
                    qNum1Arr[borrowFromIndex]--;
                    document.getElementById(`d1-${borrowFromIndex}`).innerHTML = `<span class="strikethrough">${qNum1Arr[borrowFromIndex]+1}</span><span class="text-orange-500">${qNum1Arr[borrowFromIndex]}</span>`;
                    tempD1 += 10;
                }
            }
            const correctDiff = tempD1 - d2;
            if (userInput === correctDiff) {
                finalAnswer = correctDiff + finalAnswer;
                finalAnswerDisplay.textContent = finalAnswer;
                currentInput.textContent = '';
                moveToNextStep();
            } else {
                handleIncorrectAnswer(true);
            }
        }
    }
    
    function moveToNextStep() {
        currentColumn++;
        if (currentColumn >= qNum1Arr.length) {
            if(carry > 0) {
                finalAnswer = carry + finalAnswer;
                finalAnswerDisplay.textContent = finalAnswer;
            }
            handleCorrectAnswer();
        } else {
            highlightCurrentColumn();
            updateKikoMessage('next_step');
        }
    }

    function handleCorrectAnswer() {
        score++;
        scoreDisplay.textContent = score;
        feedbackEl.textContent = 'Benar! 🎉';
        feedbackEl.className = 'text-4xl text-white text-center font-bold h-12 mb-2 animate-bounce';
        updateKikoMessage('correct');
        currentQuestionIndex++;
        setTimeout(() => {
            feedbackEl.textContent = '';
            feedbackEl.className = 'text-4xl text-white text-center font-bold h-12 mb-2';
            displayQuestion();
        }, 1800);
    }
    
    function handleIncorrectAnswer(isStepByStep = false) {
        feedbackEl.textContent = 'Salah! 😥';
        feedbackEl.className = 'text-4xl text-red-400 text-center font-bold h-12 mb-2';
        updateKikoMessage('incorrect');
        currentInput.textContent = '';
    }

    function showResult() {
        showScreen('resultScreen');
        finalScoreEl.textContent = score;
        starContainer.innerHTML = '';
        const stars = Math.max(1, Math.floor((score / TOTAL_QUESTIONS) * 3));
        for (let i = 0; i < 3; i++) {
            const star = document.createElement('span');
            star.textContent = '⭐';
            star.className = `text-6xl ${i < stars ? '' : 'opacity-30'}`;
            starContainer.appendChild(star);
        }
    }
    
    function updateKikoMessage(type) {
        const messages = {
            'default': 'Kerjakan kolom paling kanan dulu!',
            'level1_hint': 'Ketik jawaban akhir dari soal ini!',
            'level2_hint': 'Ketik hasil hitung untuk kolom ini!',
            'next_step': 'Bagus! Lanjut ke kolom berikutnya!',
            'correct': 'Hebat! Kamu Jenius!',
            'incorrect': 'Oops, coba lagi yuk!',
            'borrow_hint': 'Perlu pinjam dari sebelah, nih!',
        };
        let msg = messages[type];
        if (type === 'default') {
            msg = currentLevel === 1 ? messages['level1_hint'] : messages['level2_hint'];
        }
        kikoMessage.textContent = msg;
    }
    
    startButton.addEventListener('click', () => showScreen('modeSelectScreen'));
    backToHomeBtn.addEventListener('click', () => showScreen('welcomeScreen'));
    backToModeBtn.addEventListener('click', () => showScreen('modeSelectScreen'));

    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            currentMode = e.currentTarget.dataset.mode;
            showScreen('levelSelectScreen');
        });
    });

    document.querySelectorAll('.level-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            currentLevel = parseInt(e.currentTarget.dataset.level);
            startGame();
        });
    });
    
    keypad.addEventListener('click', (e) => {
        if (!e.target.matches('[data-key]')) return;
        if (!currentInput) return;
        const key = e.target.dataset.key;
        const maxInputLength = (currentLevel === 1) ? 5 : 2;

        if (key === 'del') {
            currentInput.textContent = currentInput.textContent.slice(0, -1);
        } else if (currentInput.textContent.length < maxInputLength) {
            currentInput.textContent += key;
        }
    });
    
    playAgainBtn.addEventListener('click', () => {
         showScreen('levelSelectScreen');
    });
    mainMenuBtn.addEventListener('click', () => showScreen('welcomeScreen'));
    backToMenuFromGameBtn.addEventListener('click', () => confirmModal.classList.add('active'));
    confirmNoBtn.addEventListener('click', () => confirmModal.classList.remove('active'));
    confirmYesBtn.addEventListener('click', () => {
        confirmModal.classList.remove('active');
        showScreen('welcomeScreen');
    });

    showScreen('welcomeScreen');
</script>
</body>
</html>
